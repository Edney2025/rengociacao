const clientsData = {
    "clients": [
      {
        "name": "Amanda Lopes Inocêncio",
        "cpf": "097.342.559-83",
        "pin": "0983",
        "debts": {
          "atrasada": {
            "value": 4289.06,
            "negotiation": {
              "entrada_minima": 1500.00,
              "parcelamento_entrada_max": 6,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 120.00,
              "taxa_saldo": 0.009
            }
          },
          "a_vencer": {
            "value": 4193.43,
            "negotiation": {
              "entrada_minima": 1000.00,
              "parcelamento_entrada_max": 6,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 85.00,
              "taxa_saldo": 0.005
            }
          },
          "total": {
            "value": 8482.49,
            "negotiation": {
              "entrada_minima": 3000.00,
              "parcelamento_entrada_max": 8,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 135.00,
              "taxa_saldo": 0.001
            }
          }
        }
      },
      {
        "name": "Maicon Pereira",
        "cpf": "111.919.319-27",
        "pin": "1127",
        "debts": {
          "atrasada": {
            "value": 2474.08,
            "negotiation": {
              "entrada_minima": 1500.00,
              "parcelamento_entrada_max": 6,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 100.00,
              "taxa_saldo": 0.005
            }
          },
          "a_vencer": {
            "value": 7515.00,
            "negotiation": {
              "entrada_minima": 3500.00,
              "parcelamento_entrada_max": 7,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 185.00,
              "taxa_saldo": 0.009
            }
          },
          "total": {
            "value": 9989.08,
            "negotiation": {
              "entrada_minima": 4500.00,
              "parcelamento_entrada_max": 10,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 175.00,
              "taxa_saldo": 0.009
            }
          }
        }
      },
      {
        "name": "Rosangela Santos",
        "cpf": "111.222.333-44",
        "pin": "3344",
        "debts": {
          "atrasada": {
            "value": 1349.40,
            "negotiation": {
              "entrada_minima": 500.00,
              "parcelamento_entrada_max": 5,
              "taxa_entrada": 0.009,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 85.00,
              "taxa_saldo": 0.02
            }
          }
        }
      },
      {
        "name": "Alexandra Inocencio",
        "cpf": "079.033.129-28",
        "pin": "0728",
        "debts": {
          "atrasada": {
            "value": 4131.87
          },
          "a_vencer": {
            "value": 2456.60
          },
          "total": {
            "value": 6588.47,
            "negotiation": {
              "entrada_minima": 1400.00,
              "parcelamento_entrada_max": 7,
              "taxa_entrada": 0.000,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 85.00,
              "taxa_saldo": 0.001
            }
          }
        }
      },
      {
        "name": "Angel Antonio",
        "cpf": "002.217.349-88",
        "pin": "0088",
        "debts": {
          "atrasada": {
            "value": 1948.87
          },
          "a_vencer": {
            "value": 10580.00
          },
          "total": {
            "value": 12528.78,
            "negotiation": {
              "entrada_minima": 3000.00,
              "parcelamento_entrada_max": 10,
              "taxa_entrada": 0.000,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 125.00,
              "taxa_saldo": 0.003
            }
          }
        }
      },
      {
        "name": "Jordan Ribeiro",
        "cpf": "073.085.399-38",
        "pin": "0738",
        "debts": {
          "atrasada": {
            "value": 2144.25
          },
          "a_vencer": {
            "value": 555.00
          },
          "total": {
            "value": 2699.26,
            "negotiation": {
              "entrada_minima": 1000.00,
              "parcelamento_entrada_max": 5,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 85.00,
              "taxa_saldo": 0.03
            }
          }
        }
      },
      {
        "name": "Jaqueline Rodrigues Lisboa",
        "cpf": "094.164.999-78",
        "pin": "9978",
        "debts": {
          "atrasada": {
            "value": 4801.00,
            "negotiation": {
              "entrada_minima": 1500.00,
              "parcelamento_entrada_max": 5,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 85.00,
              "taxa_saldo": 0.02
            }
          }
        }
      },
      {
        "name": "Idaiana Teixeira Guimarães",
        "cpf": "078.701.689-63",
        "pin": "8963",
        "debts": {
          "atrasada": {
            "value": 455.54,
            "negotiation": {
              "entrada_minima": 200.00,
              "parcelamento_entrada_max": 1,
              "taxa_entrada": 0.000,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 50.00,
              "taxa_saldo": 0.009
            }
          }
        }
      },
      {
        "name": "Carlos Augusto",
        "cpf": "44998606792",
        "pin": "4492",
        "debts": {
          "atrasada": {
            "value": 130.00,
            "notification_advogado": 150.00
          },
          "total": {
            "value": 280.00,
            "negotiation": {
              "entrada_minima": 80.00,
              "parcelamento_entrada_max": 5,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 25.00,
              "taxa_saldo": 0.09
            }
          }
        }
      },
      {
        "name": "Wilian Tiago dos Santos Silva",
        "cpf": "082.913.159-06",
        "pin": "5906",
        "debts": {
          "atrasada": {
            "value": 350.00,
            "notification_advogado": 150.00
          },
          "total": {
            "value": 500.00,
            "negotiation": {
              "entrada_minima": 150.00,
              "parcelamento_entrada_max": 2,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 25.00,
              "taxa_saldo": 0.09
            }
          }
        }
      },
      {
        "name": "Paulo Ricardo de Oliveira Correira",
        "cpf": "079.010.139-40",
        "pin": "3940",
        "debts": {
          "atrasada": {
            "value": 225.00,
            "notification_advogado": 150.00
          },
          "total": {
            "value": 375.00,
            "negotiation": {
              "entrada_minima": 150.00,
              "parcelamento_entrada_max": 2,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 25.00,
              "taxa_saldo": 0.09
            }
          }
        }
      },
      {
        "name": "Monica Riquelme",
        "cpf": "707.604.741-17",
        "pin": "4117",
        "debts": {
          "atrasada": {
            "value": 835.69,
            "negotiation": {
              "entrada_minima": 300.00,
              "parcelamento_entrada_max": 3,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 50.00,
              "taxa_saldo": 0.09
            }
          }
        }
      },
      {
        "name": "Marina Srivan",
        "cpf": "078.900.679-09",
        "pin": "7909",
        "debts": {
          "atrasada": {
            "value": 1248.56
          },
          "vencendo_hoje": {
            "value": 250.00
          },
          "a_vencer": {
            "value": 4110.00
          },
          "total": {
            "value": 5608.56,
            "negotiation": {
              "entrada_minima": 2000.00,
              "parcelamento_entrada_max": 4,
              "taxa_entrada": 0.000,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 100.00,
              "taxa_saldo": 0.001
            }
          }
        }
      },
      {
        "name": "Luciano Oliveira da Costa",
        "cpf": "717.954.052-87",
        "pin": "5287",
        "debts": {
          "atrasada": {
            "value": 537.63,
            "negotiation": {
              "entrada_minima": 300.00,
              "parcelamento_entrada_max": 2,
              "taxa_entrada": 0.005,
              "parcelamento_saldo_max": 96,
              "parcela_minima_saldo": 75.00,
              "taxa_saldo": 0.02
            }
          }
        }
      }
    ]
  };

const screens = {
    login: document.getElementById('login-screen'),
    dashboard: document.getElementById('dashboard-screen'),
    proposals: document.getElementById('proposals-screen'),
    simulation: document.getElementById('simulation-screen')
};

const loginForm = document.getElementById('login-form');
const cpfInput = document.getElementById('cpf');
const pinInput = document.getElementById('pin');
const loginError = document.getElementById('login-error');

const welcomeMessage = document.getElementById('welcome-message');
const atrasadaValue = document.getElementById('atrasada-value');
const aVencerValue = document.getElementById('a-vencer-value');
const viewProposalsBtn = document.getElementById('view-proposals-btn');
const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');

const proposalsList = document.getElementById('proposals-list');

const simulationTitle = document.getElementById('simulation-title');
const negotiatedValueSpan = document.getElementById('negotiated-value');
const entradaValueSpan = document.getElementById('entrada-value');
const entradaParcelasInput = document.getElementById('entrada-parcelas');
const entradaParcelasDisplay = document.getElementById('entrada-parcelas-display');
const entradaParcelaValue = document.getElementById('entrada-parcela-value');
const saldoValueSpan = document.getElementById('saldo-value');
const saldoParcelasInput = document.getElementById('saldo-parcelas');
const saldoParcelasDisplay = document.getElementById('saldo-parcelas-display');
const saldoParcelaValue = document.getElementById('saldo-parcela-value');
const saldoInfo = document.getElementById('saldo-info');
const confirmAgreementBtn = document.getElementById('confirm-agreement-btn');
const backToProposalsBtn = document.getElementById('back-to-proposals-btn');

let currentClient = null;
let currentProposal = null;

// Helper functions
function showScreen(screenName) {
    for (let key in screens) {
        if(screens[key]) screens[key].classList.remove('active');
    }
    if(screens[screenName]) screens[screenName].classList.add('active');
}

function formatCurrency(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function calculateInstallment(principal, rate, periods) {
    if (rate === 0 || !rate) {
        return principal / periods;
    }
    const i = rate;
    const numerator = principal * i * Math.pow(1 + i, periods);
    const denominator = Math.pow(1 + i, periods) - 1;
    if (denominator === 0) return principal / periods;
    return numerator / denominator;
}


// Login Logic
cpfInput.addEventListener('input', (e) => {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 9) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2}).*/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/^(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/^(\d{3})(\d{3})/, '$1.$2');
    }
    e.target.value = value;
});

loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const cpf = cpfInput.value;
    const pin = pinInput.value;

    currentClient = clientsData.clients.find(client => client.cpf === cpf && client.pin === pin);

    if (currentClient) {
        loginError.textContent = '';
        welcomeMessage.textContent = `Olá, ${currentClient.name.split(' ')[0]}!`;
        atrasadaValue.textContent = formatCurrency(currentClient.debts.atrasada ? currentClient.debts.atrasada.value : 0);
        aVencerValue.textContent = formatCurrency(currentClient.debts.a_vencer ? currentClient.debts.a_vencer.value : 0);
        showScreen('dashboard');
    } else {
        loginError.textContent = 'CPF ou PIN incorretos.';
    }
});

// Dashboard Logic
viewProposalsBtn.addEventListener('click', () => {
    proposalsList.innerHTML = ''; // Clear previous proposals
    if (currentClient) {
        const debtTypeMap = {
            atrasada: 'Dívidas Atrasadas',
            a_vencer: 'Dívidas a Vencer',
            total: 'Saldo Devedor Total'
        };

        for (const debtType in currentClient.debts) {
            const debt = currentClient.debts[debtType];
            if (debt.negotiation) {
                const proposalCard = document.createElement('div');
                proposalCard.classList.add('proposal-card');
                
                // Adiciona a classe de cor baseada no tipo de dívida
                if (debtType === 'atrasada' || debtType === 'a_vencer' || debtType === 'total') {
                    proposalCard.classList.add(debtType);
                }

                proposalCard.dataset.debtType = debtType;
                proposalCard.innerHTML = `
                    <h3>Opção: Renegociar ${debtTypeMap[debtType] || debtType}</h3>
                    <p>Valor Negociado: <strong>${formatCurrency(debt.value)}</strong></p>
                    <p>Entrada a partir de: <strong>${formatCurrency(debt.negotiation.entrada_minima)}</strong>  em até ${debt.negotiation.parcelamento_entrada_max}x</p>
                    <p>Saldo restante: até ${debt.negotiation.parcelamento_saldo_max}x, parcela mínima ${formatCurrency(debt.negotiation.parcela_minima_saldo)}</p>
                    <button class="select-proposal-btn">Selecionar</button>
                `;
                proposalsList.appendChild(proposalCard);
            }
        }

        document.querySelectorAll('.select-proposal-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const debtType = e.target.closest('.proposal-card').dataset.debtType;
                currentProposal = currentClient.debts[debtType];
                loadSimulationScreen();
            });
        });
    }
    showScreen('proposals');
});

backToDashboardBtn.addEventListener('click', () => {
    showScreen('dashboard');
});

// Simulation Logic
function loadSimulationScreen() {
    if (!currentProposal) return;
    
    const debtTypeMap = {
        atrasada: 'Dívidas Atrasadas',
        a_vencer: 'Dívidas a Vencer',
        total: 'Saldo Devedor Total'
    };
    const debtType = Object.keys(currentClient.debts).find(key => currentClient.debts[key] === currentProposal);
    simulationTitle.textContent = `Simulação para ${debtTypeMap[debtType] || debtType}`;
    negotiatedValueSpan.textContent = formatCurrency(currentProposal.value);

    const entradaMinima = currentProposal.negotiation.entrada_minima;
    const maxParcelasEntrada = currentProposal.negotiation.parcelamento_entrada_max;

    entradaValueSpan.textContent = formatCurrency(entradaMinima);
    entradaParcelasInput.max = maxParcelasEntrada;
    entradaParcelasInput.value = 1; // Reset to 1
    updateEntradaSimulation();

    const maxParcelasSaldo = currentProposal.negotiation.parcelamento_saldo_max;
    
    saldoParcelasInput.max = maxParcelasSaldo;
    saldoParcelasInput.value = 1; // Reset to 1
    updateSaldoSimulation();

    showScreen('simulation');
}

function updateEntradaSimulation() {
    const principal = currentProposal.negotiation.entrada_minima;
    const periods = parseInt(entradaParcelasInput.value);
    const rate = currentProposal.negotiation.taxa_entrada;
    const installment = calculateInstallment(principal, rate, periods);
    entradaParcelasDisplay.textContent = `${periods}x`;
    entradaParcelaValue.textContent = formatCurrency(installment);
}

function updateSaldoSimulation() {
    const principal = currentProposal.value - currentProposal.negotiation.entrada_minima;
    let periods = parseInt(saldoParcelasInput.value);
    const rate = currentProposal.negotiation.taxa_saldo;
    const parcelaMinima = currentProposal.negotiation.parcela_minima_saldo;

    let installment = calculateInstallment(principal, rate, periods);

    if (installment < parcelaMinima && principal > 0) {
        saldoInfo.textContent = `Atenção: O valor da parcela do saldo não pode ser inferior a ${formatCurrency(parcelaMinima)}.`;
    } else {
        saldoInfo.textContent = '';
    }

    saldoParcelasDisplay.textContent = `${periods}x`;
    saldoParcelaValue.textContent = formatCurrency(installment);
}

entradaParcelasInput.addEventListener('input', updateEntradaSimulation);
saldoParcelasInput.addEventListener('input', updateSaldoSimulation);

confirmAgreementBtn.addEventListener('click', () => {
    const debtTypeMap = {
        atrasada: 'Dívidas Atrasadas',
        a_vencer: 'Dívidas a Vencer',
        total: 'Saldo Devedor Total'
    };
    const debtType = Object.keys(currentClient.debts).find(key => currentClient.debts[key] === currentProposal);

    // Calcula valores finais
    const entradaPeriods = parseInt(entradaParcelasInput.value);
    const entradaPrincipal = currentProposal.negotiation.entrada_minima;
    const entradaRate = currentProposal.negotiation.taxa_entrada;
    const entradaInstallment = calculateInstallment(entradaPrincipal, entradaRate, entradaPeriods);

    const saldoPeriods = parseInt(saldoParcelasInput.value);
    const saldoPrincipal = currentProposal.value - currentProposal.negotiation.entrada_minima;
    const saldoRate = currentProposal.negotiation.taxa_saldo;
    const saldoInstallment = calculateInstallment(saldoPrincipal, saldoRate, saldoPeriods);

    // Monta a mensagem para o WhatsApp
    const phoneNumber = "44998408460";
    let message = `Olá! Gostaria de confirmar minha renegociação.\n\n`;
    message += `*Cliente:* ${currentClient.name}\n`;
    message += `*CPF:* ${currentClient.cpf}\n`;
    message += `*Tipo de Negociação:* ${debtTypeMap[debtType] || debtType}\n`;
    message += `*Valor Total Negociado:* ${formatCurrency(currentProposal.value)}\n\n`;
    message += `*== RESUMO DO ACORDO ==*\n`;
    message += `*Entrada:* ${entradaPeriods}x de ${formatCurrency(entradaInstallment)}\n`;
    message += `*Saldo Restante:* ${saldoPeriods}x de ${formatCurrency(saldoInstallment)}\n\n`;
    message += `Aguardo as instruções para os próximos passos.`;

    // Cria a URL e redireciona
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    
    // Abre em uma nova aba para não perder a sessão atual
    window.open(whatsappUrl, '_blank');
});


backToProposalsBtn.addEventListener('click', () => {
    showScreen('proposals');
});

// Initial screen
showScreen('login');